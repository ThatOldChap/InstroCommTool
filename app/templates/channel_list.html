{% extends "base.html" %}
{% import 'bootstrap/form.html' as wtf %}

{% block app_content %}
    <div>
        <h1>Channel List:</h1>
        <form action="" method="POST" name="channel_group_form">
            {{ channel_group_form.hidden_tag() }}
            <table class="table table-hover table-bordered align-middle">
                <thead>
                    <tr class="table-primary text-center align-middle">
                        <th class="align-middle">Item #</th>
                        <th class="align-middle">Channel Name</th>
                        <th class="align-middle">Input</th>
                        <th class="align-middle">Min/Measured/Max</th>
                        <th class="align-middle">Error</th>
                        <th class="align-middle">Date Updated</th>
                        <th class="align-middle">Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {# Loop through each channel and channel_form #}
                    {% for channel, channel_form in zip(channel_list, channel_group_form.channels) %}
                        {# Loop through each channel's testpoint and each channel_form's testpoint form #}
                        {% for testpoint, testpoint_form in zip(channel.all_test_points(), channel_form.testpoints) %}
                            {% include '_testpoint.html' %}
                        {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </form>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}

    <!-- JQuery to handle the form submission -->
    <script>
        $(document).ready(function() {

            $('.input-val').change(function(element) {

                let input_val_elem = element.target;
                let data = {id: input_val_elem.dataset.testpointId, input_val: input_val_elem.value};
                updateTestPoint(data); 
            });

            $('.meas-val').change(function(element) {

                // Unpack the data
                let meas_val_elem = element.target;                
                let id = meas_val_elem.dataset.testpointId;
                let meas_val_nom = parseFloat(meas_val_elem.placeholder);
                let meas_val = parseFloat(meas_val_elem.value);
                let data = {id: id, meas_val: meas_val};
                updateTestPoint(data); 

                // Calculate the error and update the field
                let error = meas_val - meas_val_nom;
                let errorElem = $(`#${this.id}`).parents('tr').find('.error');

                // Update the error value in the element
                if(Number.isNaN(meas_val)) {
                    errorElem.val('');
                } else {
                    errorElem.val(error);
                }                
            });
            // "channels-0-testpoints-0-meas_val"
            function parseID(id) {
                let idString = id.split('-');
                // Returns [channels, 0, testpoints, 0, meas_val]

            }

            $('.notes').change(function(element) {

                let notes_elem = element.target;
                let data = {id: notes_elem.dataset.testpointId, notes: notes_elem.value};
                updateTestPoint(data); 
            });

            $('.error').change(function(element) {

                let error_elem = element.target;
                let data = {id: error_elem.dataset.testpointId, error: error_elem.value};
                updateTestPoint(data);                
            });

            function updateTestPoint(data) {
                $.ajax({
                    type: 'POST',
                    url: '/update_testpoint',
                    data: data,
                    success: function(response) {
                        console.log(response['message']);
                    },
                    error: function(error) {
                        console.log(`Error updating testpoint: ${error}`);
                    }
                });
            }

        });
    </script>

{% endblock %}